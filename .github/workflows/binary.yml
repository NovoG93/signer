name: Build and Release Binary

on:
  workflow_call:
    inputs:
      go_version:
        description: Go version
        required: true
        type: string
    secrets:
      token:
        description: GitHub token
        required: true


jobs:
  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')

    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ inputs.go_version }}

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          cd src
          CGO_ENABLED=0 go build -ldflags="-w -s" -o ../signer-${{ matrix.goos }}-${{ matrix.goarch }} .
          if [ "${{ matrix.goos }}" == "windows" ]; then
            mv ../signer-${{ matrix.goos }}-${{ matrix.goarch }} ../signer-${{ matrix.goos }}-${{ matrix.goarch }}.exe
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: signer-${{ matrix.goos }}-${{ matrix.goarch }}
          path: signer-${{ matrix.goos }}-*
          retention-days: 1

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: ["build-binaries"]

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v6.0.0
        with:
          path: ./binaries

      - name: Organize binaries
        run: |
          mkdir -p release
          find binaries -type f -name "signer-*" -exec cp {} release/ \;
          ls -la release/

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.token }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --generate-notes \
            release/*
